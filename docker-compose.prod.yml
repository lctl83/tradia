# docker-compose.prod.yml
# Configuration PRODUCTION pour serveur DCI
# Usage: docker compose -f docker-compose.prod.yml up -d --build

services:
  tradia:
    build:
      context: .
      args:
        - HTTP_PROXY=${HTTP_PROXY:-}
        - HTTPS_PROXY=${HTTPS_PROXY:-}
        - NO_PROXY=localhost,127.0.0.1
    container_name: tradia
    restart: always
    environment:
      # Connexion Serveur IA (Caddy + HTTPS)
      - OLLAMA_BASE_URL=https://itapprspia01.dci.local/api
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:-}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-ministral-3:latest}
      - OLLAMA_TIMEOUT=300
      - OLLAMA_MAX_RETRIES=5
      - UVICORN_PORT=8000

      # Configuration App
      - MAX_UPLOAD_MB=100
      - BATCH_SIZE=20

      # Proxy entreprise (si nécessaire pour accès externe)
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,itapprspia01.dci.local}

      # Logging production
      - LOG_LEVEL=WARNING
      - DEBUG=false

    # Healthcheck
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/healthz" ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

    # Ressources pour serveur Tradia (2 vCPU, 8 Go RAM)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 2G

    # Logs de production
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    ports:
      - "8000:8000"

    volumes:
      - ./logs:/app/logs
      # Certificats PKI internes DCI (si nécessaire pour HTTPS)
      - /etc/ssl/certs:/etc/ssl/certs:ro

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tradia.entrypoints=websecure"
      - "traefik.http.routers.tradia.rule=PathPrefix(`/`)"
      - "traefik.http.routers.tradia.tls=true"
      - "traefik.http.routers.tradia.middlewares=no-buffering@file"
      - "traefik.http.services.tradia.loadbalancer.server.port=8000"

  traefik:
    image: traefik:v2.11
    container_name: tradia-traefik
    restart: always
    depends_on:
      tradia:
        condition: service_healthy
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--log.level=WARN"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - /etc/ssl/itapprspia:/etc/traefik/certs:ro
      - ./logs/traefik:/var/log/traefik

networks:
  default:
    name: tradia-network
